import jsonlines
import os
import json

BRANDS = os.listdir("data/raw/brands")


rule all:
    input:
        "data/interim/rules/brands.jsonl",
        expand("data/interim/rules/brands/{brand}", brand=BRANDS),
        "data/interim/pledges_with_spaces.xls",
        "data/interim/rules/all_rules.jsonl",
        "data/interim/all_raw_rules.jsonl",
        "data/processed/pledges_ner.xls",

rule create_rules_brands:
    input:
        "data/raw/brands.jsonl",
    output:
        "data/interim/rules/brands.jsonl"
    shell:
        "python src/data/prepare_rules_brands.py '{input}' '{output}'"


rule create_rules_models:
    input:
        "data/raw/brands/{brand}"
    output:
        "data/interim/rules/brands/{brand}"
    shell:
        "python src/data/prepare_rules_models.py '{input}' '{output}'"

rule concat_raw:
    input:
        "data/raw/brands.jsonl",
        expand("data/raw/brands/{brand}", brand=BRANDS),
    output:
        "data/interim/all_raw_rules.jsonl"
    run: 
        l = []
        for f in input:
            l = l + list(jsonlines.open(f))
        print(output[0])
        with jsonlines.open(output[0], mode='w') as writer:
            for entry in l:
                writer.write(entry)

rule concat_rules:
    input:
        "data/interim/rules/brands.jsonl",
        expand("data/interim/rules/brands/{brand}", brand=BRANDS),
    output:
        "data/interim/rules/all_rules.jsonl"
    run: 
        l = []
        for f in input:
            l = l + list(jsonlines.open(f))
        print(output[0])
        with jsonlines.open(output[0], mode='w') as writer:
            for entry in l:
                writer.write(entry)

rule add_spaces:
    input:
        "data/raw/pledges.csv",
        "data/interim/all_raw_rules.jsonl"
    output:
        "data/interim/pledges_with_spaces.xls"
    shell:
        "python src/data/add_spaces.py {input} {output}"

rule add_ner:
    input:
        "data/interim/pledges_with_spaces.xls",
        "data/interim/rules/all_rules.jsonl"
    output:
        "data/processed/pledges_ner.xls"
    shell:
        "python src/models/find_NER.py {input} {output}"